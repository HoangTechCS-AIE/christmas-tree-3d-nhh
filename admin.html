<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Qu·∫£n L√Ω L·ªùi Ch√∫c</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #d4af37;
            text-align: center;
        }

        .login-box,
        .dashboard {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .hidden {
            display: none;
        }

        input[type="password"],
        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #404040;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            transition: background 0.3s;
        }

        button:hover {
            background: #fceea7;
        }

        .wish-item {
            background: #404040;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }

        .wish-text {
            flex-grow: 1;
            margin-right: 10px;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>üéÅ Qu·∫£n L√Ω L·ªùi Ch√∫c</h1>

    <div id="login-section" class="login-box">
        <h3>ƒêƒÉng nh·∫≠p Admin</h3>
        <input type="password" id="admin-pass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u Admin...">
        <button onclick="login()">V√†o Qu·∫£n L√Ω</button>
        <p id="login-msg" style="color: red;"></p>
    </div>

    <div id="dashboard" class="dashboard hidden">
        <div style="display:flex; gap:10px; margin-bottom: 20px; align-items: center;">
            <input type="text" id="new-group-pass" placeholder="M·∫≠t kh·∫©u nh√≥m m·ªõi..." style="width: 150px;">
            <button onclick="addGroup()">+ T·∫°o Nh√≥m</button>
        </div>

        <div id="group-list">
            <!-- Groups go here -->
        </div>

        <div style="margin-top: 20px; text-align: right;">
            <button onclick="saveAll()"
                style="background: #4CAF50; color: white; font-size: 16px; padding: 12px 24px;">L∆∞u T·∫•t C·∫£ Thay
                ƒê·ªïi</button>
        </div>
        <p id="status-msg" style="margin-top: 10px; color: yellow; text-align: right;"></p>
    </div>

    <script>
        let wishGroups = {}; // Object: { "pass": ["wish1", "wish2"] }
        let adminToken = '';

        function login() {
            const pass = document.getElementById('admin-pass').value;
            fetch('/api/wishes', {
                headers: { 'x-admin-password': pass }
            })
                .then(async res => {
                    if (res.ok) return res.json();
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || 'L·ªói server (Check Console)');
                })
                .then(data => {
                    adminToken = pass;
                    wishGroups = data; // Now an object
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    renderGroups();
                })
                .catch(err => {
                    document.getElementById('login-msg').innerText = err.message;
                });
        }

        function renderGroups() {
            const list = document.getElementById('group-list');
            list.innerHTML = '';

            for (const [password, wishes] of Object.entries(wishGroups)) {
                const groupDiv = document.createElement('div');
                groupDiv.style.background = '#333';
                groupDiv.style.marginBottom = '20px';
                groupDiv.style.padding = '15px';
                groupDiv.style.borderRadius = '8px';
                groupDiv.style.border = '1px solid #d4af37';

                let wishesHtml = '';
                wishes.forEach((w, i) => {
                    wishesHtml += `
                        <div class="wish-item">
                            <input type="text" class="wish-text" value="${w}" onchange="updateWish('${password}', ${i}, this.value)">
                            <button class="delete-btn" onclick="removeWish('${password}', ${i})">X√≥a</button>
                        </div>
                    `;
                });

                groupDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:10px;">
                        <h3 style="margin:0; color:#d4af37;">üîë Password: <span style="color:#fff;">${password}</span></h3>
                        <div>
                            <button onclick="addWishToGroup('${password}')" style="background:#2196F3; font-size:12px;">+ Th√™m L·ªùi Ch√∫c</button>
                            <button onclick="removeGroup('${password}')" style="background:#ff4444; font-size:12px;">X√≥a Nh√≥m</button>
                        </div>
                    </div>
                    ${wishesHtml}
                `;
                list.appendChild(groupDiv);
            }
        }

        function addGroup() {
            const pass = document.getElementById('new-group-pass').value.trim();
            if (!pass) return alert("Nh·∫≠p m·∫≠t kh·∫©u cho nh√≥m m·ªõi!");
            if (wishGroups[pass]) return alert("Nh√≥m n√†y ƒë√£ t·ªìn t·∫°i!");

            wishGroups[pass] = ["Ch√∫c m·ª´ng nƒÉm m·ªõi!"];
            document.getElementById('new-group-pass').value = '';
            renderGroups();
        }

        function removeGroup(pass) {
            if (confirm(`X√≥a to√†n b·ªô nh√≥m "${pass}"?`)) {
                delete wishGroups[pass];
                renderGroups();
            }
        }

        function addWishToGroup(pass) {
            wishGroups[pass].push("L·ªùi ch√∫c m·ªõi...");
            renderGroups();
        }

        function removeWish(pass, index) {
            wishGroups[pass].splice(index, 1);
            renderGroups();
        }

        function updateWish(pass, index, val) {
            wishGroups[pass][index] = val;
        }

        function saveAll() {
            const btn = document.querySelector('button[onclick="saveAll()"]');
            btn.innerText = "ƒêang l∆∞u...";
            btn.disabled = true;

            fetch('/api/wishes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-admin-password': adminToken
                },
                body: JSON.stringify(wishGroups)
            })
                .then(async res => {
                    if (res.ok) {
                        document.getElementById('status-msg').innerText = "‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!";
                        setTimeout(() => document.getElementById('status-msg').innerText = "", 3000);
                    } else {
                        throw new Error(await res.text());
                    }
                })
                .catch(err => {
                    alert("L·ªói khi l∆∞u: " + err.message);
                })
                .finally(() => {
                    btn.innerText = "L∆∞u Thay ƒê·ªïi";
                    btn.disabled = false;
                });
        }
    </script>


</body>

</html>